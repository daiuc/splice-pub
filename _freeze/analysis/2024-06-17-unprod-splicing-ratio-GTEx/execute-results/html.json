{
  "hash": "f1e09e236b8ed9e9651ebcf59c68acae",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Unproductive splicing ratio in GTEx across tissues\"\ndate: 2024-6-17\nparams: \n  fdr: 0.1\ncategories: ['unproductive splicing', 'psi']\ncode-fold: true\nexecute:\n  include: true\n  cache: true\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntissues <- dir(\"/project/yangili1/cdai/SpliFi/code/results/pheno/noisy/GTEx\")\ntissues <- tissues[!str_detect(tissues, \"Bladder\")]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncomputeUnprodRatio <- function(tissue_rds) {\n\n    introns <- readRDS(tissue_rds)\n    datacols <- names(introns)[5:ncol(introns)]\n    # remove clu_type == N, clusters with only unproductive introns\n    introns  <- introns[str_detect(clu_type, 'PR')]\n    # total reads (by sample)\n    totals <- colSums(introns[, ..datacols])\n    # unproudctive reads (by sample)\n    unprod <- introns[intron_type == 'UP', ..datacols] %>% colSums\n    # unproductive reads / total reads\n    if (all(names(totals) == names(unprod))) {\n        unprod_ratio <- round(unprod / totals, 5)\n    } else {\n        stop('samples of totals and unprod are not the same')\n    }\n\n    return(unprod_ratio)\n\n}\n\n\npoint_scale <- function(x, newmin, newmax) {\n  newmax  <- max(newmax)\n  newmin  <- min(newmin)\n  new_range <- abs(newmax - newmin) \n  old_range <- abs(max(x) - min(x))\n\n  # Normalize the values between 0 and 1\n  normalized_x <- (x - min(x)) / old_range\n\n  # Scale the normalized values to the new range and offset by 0.5\n  scaled_x <- normalized_x * new_range + newmin\n\n  return(scaled_x)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntissues_rds <- glue(\"/project/yangili1/cdai/SpliFi/data/ExtractFractions/GTEx/{tissues}.numerators_constcounts.noise_by_intron.rds\")\nnames(tissues_rds) <- tissues\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nratios <- map(tissues_rds, computeUnprodRatio)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nratios <- imap_dfr(\n    ratios,\n    \\(x, y) enframe(x, \"sample\", \"unprodRatio\") %>% add_column(tissue = y)\n)\nratios  <- as.data.table(ratios) %>%\n    .[, .(sample, unprodRatio, nsample = uniqueN(sample)), by = tissue]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nratios[, .(median_prod_ratio = median(unprodRatio)), by = tissue][order(-median_prod_ratio)]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                                  tissue median_prod_ratio\n 1:                               Testis          0.009140\n 2:                     Brain-Cerebellum          0.007230\n 3:           Brain-CerebellarHemisphere          0.006740\n 4:        Brain-Spinalcord_cervicalc-1_          0.006150\n 5:                              Thyroid          0.005650\n 6:                             Prostate          0.005630\n 7:                         Nerve-Tibial          0.005360\n 8:                               Spleen          0.005230\n 9:                            Pituitary          0.004970\n10:                Brain-Substantianigra          0.004820\n11:                                Ovary          0.004780\n12:                                 Lung          0.004705\n13:                        Kidney-Cortex          0.004650\n14:                    Brain-Hippocampus          0.004630\n15:         SmallIntestine-TerminalIleum          0.004630\n16:                 Breast-MammaryTissue          0.004540\n17:                               Uterus          0.004515\n18:                   Brain-Hypothalamus          0.004450\n19:       Skin-NotSunExposed_Suprapubic_          0.004310\n20:                         Brain-Cortex          0.004290\n21:                               Vagina          0.004290\n22:                 Adipose-Subcutaneous          0.004220\n23:                       Brain-Amygdala          0.004160\n24:          Brain-Putamen_basalganglia_          0.004150\n25:            Skin-SunExposed_Lowerleg_          0.004140\n26:                        Colon-Sigmoid          0.004110\n27:          Brain-Caudate_basalganglia_          0.004070\n28: Brain-Nucleusaccumbens_basalganglia_          0.004065\n29:            Adipose-Visceral_Omentum_          0.004010\n30:                     Colon-Transverse          0.003955\n31:   Esophagus-GastroesophagealJunction          0.003910\n32:  Brain-Anteriorcingulatecortex_BA24_          0.003890\n33:             Brain-FrontalCortex_BA9_          0.003820\n34:                           WholeBlood          0.003730\n35:                   MinorSalivaryGland          0.003705\n36:                 Esophagus-Muscularis          0.003690\n37:                        Artery-Tibial          0.003570\n38:                      Artery-Coronary          0.003520\n39:                              Stomach          0.003450\n40:                         Artery-Aorta          0.003440\n41:                         AdrenalGland          0.003435\n42:                Heart-AtrialAppendage          0.003400\n43:                                Liver          0.003160\n44:     Cells-EBV-transformedlymphocytes          0.003110\n45:                     Esophagus-Mucosa          0.002960\n46:                  Heart-LeftVentricle          0.002650\n47:                             Pancreas          0.002460\n48:                      Muscle-Skeletal          0.002450\n49:            Cells-Culturedfibroblasts          0.001860\n                                  tissue median_prod_ratio\n```\n\n\n:::\n\n```{.r .cell-code}\nmedian_unprod_ratio_all_gtex <- ratios[tissue != \"EUR\", .(median_prod_ratio = median(unprodRatio)), by = tissue\n    ][order(-median_prod_ratio)] %>% \n    pull(median_prod_ratio) %>% median\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntissue.labels <- fread(\"/project/yangili1/cdai/splice-pub/analysis/gtex-tissue-code.csv\",\n                       header = F, col.names = c(\"tissue\", \"label\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- ratios[, .(sample, unprodRatio, nsample, med = median(unprodRatio),rk=rank(unprodRatio, ties.method = \"first\")), by = tissue\n        ][, .(sample, unprodRatio, nsample, med, tissue = forcats::fct_reorder(tissue, -med), rk)\n        ][, .(sample, tissue, unprodRatio, nsample, med, tissuei = as.integer(tissue), rk)\n        ][, .(sample, unprodRatio, nsample, med, tissuei, rk, pointx = point_scale(rk, (tissuei - .5), tissuei+.5)), by = tissue\n        ][order(tissuei, rk)] %>% \n    left_join(y = tissue.labels, by = \"tissue\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlabels  <- df[, .(tissue, label, tissuei, nsample)] %>% unique\nlabels\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                                  tissue   label tissuei nsample\n 1:                               Testis  TESTIS       1     361\n 2:                     Brain-Cerebellum   BRNCB       2     241\n 3:           Brain-CerebellarHemisphere  BRNCBH       3     215\n 4:        Brain-Spinalcord_cervicalc-1_  BRNSPC       4     159\n 5:                              Thyroid THYROID       5     653\n 6:                             Prostate  PRSTTE       6     245\n 7:                         Nerve-Tibial  NERVET       7     619\n 8:                               Spleen  SPLEEN       8     241\n 9:                            Pituitary  PTTARY       9     283\n10:                Brain-Substantianigra  BRNSNG      10     139\n11:                                Ovary   OVARY      11     180\n12:                                 Lung    LUNG      12     578\n13:                        Kidney-Cortex  KDNCTX      13      85\n14:                    Brain-Hippocampus  BRNHPC      14     197\n15:         SmallIntestine-TerminalIleum  SNTTRM      15     187\n16:                 Breast-MammaryTissue  BREAST      16     459\n17:                               Uterus  UTERUS      17     142\n18:                   Brain-Hypothalamus  BRNHPT      18     202\n19:       Skin-NotSunExposed_Suprapubic_  SKINNS      19     604\n20:                         Brain-Cortex   BRNCT      20     255\n21:                               Vagina  VAGINA      21     156\n22:                 Adipose-Subcutaneous  ADPSBO      22     663\n23:                       Brain-Amygdala  BRNAGD      23     152\n24:          Brain-Putamen_basalganglia_  BRNPBG      24     205\n25:            Skin-SunExposed_Lowerleg_   SKINS      25     701\n26:                        Colon-Sigmoid  CLNSGM      26     373\n27:          Brain-Caudate_basalganglia_  BRNCDB      27     246\n28: Brain-Nucleusaccumbens_basalganglia_  BRNNAB      28     246\n29:            Adipose-Visceral_Omentum_  ADPVSC      29     541\n30:                     Colon-Transverse  CLNTRN      30     406\n31:   Esophagus-GastroesophagealJunction  ESPGEL      31     375\n32:  Brain-Anteriorcingulatecortex_BA24_  BRNATG      32     176\n33:             Brain-FrontalCortex_BA9_  BRNFCT      33     209\n34:                           WholeBlood  WHLBLD      34     755\n35:                   MinorSalivaryGland  SLVRYG      35     162\n36:                 Esophagus-Muscularis  ESPMSL      36     515\n37:                        Artery-Tibial  ARTTBL      37     663\n38:                      Artery-Coronary  ARTCRN      38     240\n39:                              Stomach  STMACH      39     359\n40:                         Artery-Aorta  ARTAOT      40     432\n41:                         AdrenalGland  ADNGLD      41     258\n42:                Heart-AtrialAppendage   HRTAA      42     429\n43:                                Liver   LIVER      43     226\n44:     Cells-EBV-transformedlymphocytes     LCL      44     174\n45:                     Esophagus-Mucosa  ESPMCS      45     555\n46:                  Heart-LeftVentricle   HRTLV      46     432\n47:                             Pancreas PNCREAS      47     328\n48:                      Muscle-Skeletal MUSCLSK      48     803\n49:            Cells-Culturedfibroblasts FIBRBLS      49     504\n                                  tissue   label tissuei nsample\n```\n\n\n:::\n:::\n\n\n:::{.column-page}\n\n::: {.cell}\n\n```{.r .cell-code}\nlabel_x1 <- function(ids) {\n    labels[tissuei == ids, label]\n}\n\nlabel_x2 <- function(ids) {\n    labels[tissuei == ids, nsample] \n}\n\n\ndf %>% left_join(y = tissue.labels, by = \"tissue\") %>%\n      ggplot() +\n        geom_point(aes(x = pointx, y = unprodRatio), color = 'midnightblue', alpha = .1) +\n        geom_tile(aes(x = tissuei, y = med), color = 'firebrick', fill= 'firebrick', height = 5e-5, width = .9) +\n        scale_x_continuous(\n            breaks = unique(df$tissuei), \n            labels = unique(df$label),\n            expand = c(0, .5),\n            guide = guide_axis(angle = 90),\n            sec.axis = sec_axis(~., \n                                breaks = unique(df$tissuei),\n                                labels = label_x2,  \n                                guide = guide_axis(angle = 90)\n                               )\n            ) +\n        scale_y_continuous(labels = scales::percent_format(accuracy = .1)) +\n        labs(x = \"Tissue / Number of Samples\",\n            y = \"Fraction of unproductive reads\"\n            )\n```\n\n::: {.cell-output-display}\n![Unproductive splicing ratio in GTEx across tissues](2024-06-17-unprod-splicing-ratio-GTEx_files/figure-html/fig-unprod_ratio_by_tissue-1.png){#fig-unprod_ratio_by_tissue width=100%}\n:::\n:::\n\n:::\n\n\n\n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}